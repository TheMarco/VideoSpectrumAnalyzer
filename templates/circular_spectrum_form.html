<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ visualizer.name }} - Audio Visualizer Suite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container mt-5 mb-5 fade-in">
        <h1 class="text-center mb-3">{{ visualizer.name }}</h1>
        <p class="text-center mb-5" style="max-width: 700px; margin-left: auto; margin-right: auto; color: var(--text-secondary);">{{ visualizer.description }}</p>

        <div class="mb-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i> Back to Visualizer Selection
            </a>
        </div>

        <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data" novalidate>
            <!-- Hidden fields -->
            <input type="hidden" name="visualizer_name" value="{{ visualizer.name }}">
            <input type="hidden" name="submitted" value="{{ submitted }}">

            <!-- Nav Tabs -->
            <ul class="nav nav-tabs nav-fill mb-4" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input-tab-pane" type="button" role="tab" aria-controls="input-tab-pane" aria-selected="true">
                        <i class="bi bi-file-music me-2"></i> 1. Input Files & Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance-tab-pane" type="button" role="tab" aria-controls="appearance-tab-pane" aria-selected="false">
                        <i class="bi bi-palette me-2"></i> 2. Appearance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-tab-pane" type="button" role="tab" aria-controls="advanced-tab-pane" aria-selected="false">
                        <i class="bi bi-gear me-2"></i> 3. Advanced & Output
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="configTabsContent">
                <!-- ======================= -->
                <!--      INPUT TAB PANE     -->
                <!-- ======================= -->
                <div class="tab-pane fade show active" id="input-tab-pane" role="tabpanel" aria-labelledby="input-tab" tabindex="0">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Input Files & Info</h5>
                             <!-- Audio File -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="file" class="form-label">Audio File* <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="right" title="Select the primary audio track (MP3, WAV, FLAC, etc.). Max 1.6GB."></i></label>
                                    <input type="file" class="form-control" id="file" name="file" accept="audio/*" required>
                                </div>
                            </div>

                            <!-- Background Media -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="background_media" class="form-label">Background Image/Video <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="right" title="Optional background image (JPG, PNG) or video (MP4). If not provided, a black background will be used."></i></label>
                                    <input type="file" class="form-control" id="background_media" name="background_media" accept="image/*,video/*">
                                </div>
                            </div>

                            <!-- Background Shader -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label for="background_shader" class="form-label">Background Shader <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="right" title="Optional GLSL shader for dynamic background effects. Takes precedence over image/video if both are provided."></i></label>
                                        <a href="/shader-explorer" class="text-decoration-none">
                                            <i class="bi bi-eye me-1"></i> Preview Shaders
                                        </a>
                                    </div>
                                    <select class="form-select" id="background_shader" name="background_shader">
                                        <option value="">None (use image/video or black background)</option>
                                        {% for shader in shaders %}
                                        <option value="{{ shader.path }}">{{ shader.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Artist and Track Info -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="artist_name" class="form-label">Artist Name <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Artist name to display in the visualization."></i></label>
                                    <input type="text" class="form-control" id="artist_name" name="artist_name" value="">
                                </div>
                                <div class="col-md-6">
                                    <label for="track_title" class="form-label">Track Title <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Track title to display in the visualization."></i></label>
                                    <input type="text" class="form-control" id="track_title" name="track_title" value="">
                                </div>
                            </div>

                            <!-- Text Colors -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="artist_color" class="form-label">Artist Text Color <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Color for the artist name text."></i></label>
                                    <input type="color" class="form-control form-control-color w-100" id="artist_color" name="artist_color" value="#FFFFFF">
                                </div>
                                <div class="col-md-6">
                                    <label for="title_color" class="form-label">Title Text Color <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Color for the track title text."></i></label>
                                    <input type="color" class="form-control form-control-color w-100" id="title_color" name="title_color" value="#FFFFFF">
                                </div>
                            </div>

                            <!-- Font Size -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="font_size" class="form-label">Font Size <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Size of the text in pixels."></i></label>
                                    <input type="number" class="form-control" id="font_size" name="font_size" value="24" min="12" max="48">
                                </div>
                            </div>
                        </div> <!-- End Card Body -->
                    </div> <!-- End Card -->
                </div> <!-- End Input Tab Pane -->

                <!-- ======================= -->
                <!--    APPEARANCE TAB PANE  -->
                <!-- ======================= -->
                <div class="tab-pane fade" id="appearance-tab-pane" role="tabpanel" aria-labelledby="appearance-tab" tabindex="0">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Circular Spectrum Settings</h5>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="num_bars" class="form-label">Number of Bars <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Number of bars around the circle (12-72)"></i></label>
                                    <input type="number" id="num_bars" name="num_bars" min="12" max="72" value="36" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="segments_per_bar" class="form-label">Segments Per Bar <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Number of segments in each bar (5-30)"></i></label>
                                    <input type="number" id="segments_per_bar" name="segments_per_bar" min="5" max="30" value="15" class="form-control">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="inner_radius" class="form-label">Inner Radius <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Inner radius of the circle (0.05-0.4)"></i></label>
                                    <input type="range" id="inner_radius" name="inner_radius" min="0.05" max="0.4" step="0.01" value="0.20" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="inner_radius_value">0.20</span></small>
                                </div>
                                <div class="col-md-6">
                                    <label for="outer_radius" class="form-label">Outer Radius <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Outer radius of the circle (0.2-0.8)"></i></label>
                                    <input type="range" id="outer_radius" name="outer_radius" min="0.2" max="0.8" step="0.01" value="0.40" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="outer_radius_value">0.40</span></small>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="segment_spacing" class="form-label">Segment Spacing <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Spacing between segments in pixels (0-10)"></i></label>
                                    <input type="range" id="segment_spacing" name="segment_spacing" min="0" max="10" step="1" value="2" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="segment_spacing_value">2</span> pixels</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="bar_width" class="form-label">Bar Width <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Width of bars (0.1-1.0, where 1.0 means bars touch, lower values create gaps)"></i></label>
                                    <input type="range" id="bar_width" name="bar_width" min="0.1" max="1.0" step="0.05" value="0.8" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="bar_width_value">0.8</span></small>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="rectangular_bars" name="rectangular_bars" checked>
                                        <label class="form-check-label" for="rectangular_bars">Use Rectangular Bars <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, bars have consistent width. When disabled, bars fan out radially (trapezoid shape)."></i></label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="use_round_segments" name="use_round_segments" checked>
                                        <label class="form-check-label" for="use_round_segments">Use Round Segments <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, segments are rendered as filled circles instead of rectangles."></i></label>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="glow_effect" name="glow_effect" checked>
                                        <label class="form-check-label" for="glow_effect">Glow Effect <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable glow effect for segments and text."></i></label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="debug_mode" name="debug_mode">
                                        <label class="form-check-label" for="debug_mode">Debug Mode <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable debug mode to help troubleshoot issues with the visualizer."></i></label>
                                    </div>
                                    <div id="debug_level_container" style="display: none;">
                                        <label for="debug_level" class="form-label mt-2">Debug Level <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Higher values show more debug information (0.3=test pattern, 0.7=bar identification, 2=full debug)"></i></label>
                                        <input type="range" id="debug_level" name="debug_level" min="0" max="2" step="0.1" value="0.7" class="form-range">
                                        <small class="form-text text-muted">Value: <span id="debug_level_value">0.7</span></small>
                                    </div>
                                </div>
                            </div>

                            <div id="glow_settings_container">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="glow_radius" class="form-label">Glow Radius <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Radius of the glow effect (0.1-0.5)"></i></label>
                                        <input type="range" id="glow_radius" name="glow_radius" min="0.1" max="0.5" step="0.05" value="0.2" class="form-range">
                                        <small class="form-text text-muted">Value: <span id="glow_radius_value">0.2</span></small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="glow_intensity" class="form-label">Glow Intensity <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Intensity of the glow effect (0.1-1.0)"></i></label>
                                        <input type="range" id="glow_intensity" name="glow_intensity" min="0.1" max="1.0" step="0.1" value="0.5" class="form-range">
                                        <small class="form-text text-muted">Value: <span id="glow_intensity_value">0.5</span></small>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="glow_color" class="form-label">Glow Color <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Color of the glow effect. If not specified, uses the segment color."></i></label>
                                        <input type="color" id="glow_color" name="glow_color" value="#FFFFFF" class="form-control form-control-color">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="glow_blur_radius" class="form-label">Text Glow Blur <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Blur radius for text glow effect (1-10)"></i></label>
                                        <input type="range" id="glow_blur_radius" name="glow_blur_radius" min="1" max="10" step="1" value="3" class="form-range">
                                        <small class="form-text text-muted">Value: <span id="glow_blur_radius_value">3</span></small>
                                    </div>
                                </div>
                            </div>

                            <h6 class="mt-4">Sensitivity & Color</h6>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="sensitivity" class="form-label">Sensitivity <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Controls how responsive the visualizer is to audio (0.5-3)"></i></label>
                                    <input type="range" id="sensitivity" name="sensitivity" min="0.5" max="3" step="0.1" value="1.0" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="sensitivity_value">1.0</span></small>
                                </div>
                                <div class="col-md-6">
                                    <label for="border_size" class="form-label">Segment Gap Size <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Size of gaps between segments (0-0.2). Higher values create more space between segments."></i></label>
                                    <input type="range" id="border_size" name="border_size" min="0" max="0.2" step="0.01" value="0.08" class="form-range">
                                    <small class="form-text text-muted">Value: <span id="border_size_value">0.08</span></small>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="segment_color" class="form-label">Segment Color <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Color for all lit segments"></i></label>
                                    <input type="color" id="segment_color" name="segment_color" value="#FFFFFF" class="form-control form-control-color w-100">
                                </div>
                            </div>
                            <div class="small text-muted mb-3">
                                <i class="bi bi-info-circle me-1"></i> Unlit segments and gaps are transparent, showing the background.
                            </div>
                        </div> <!-- End Card Body -->
                    </div> <!-- End Card -->
                </div> <!-- End Appearance Tab Pane -->

                <!-- ======================= -->
                <!--    ADVANCED TAB PANE    -->
                <!-- ======================= -->
                <div class="tab-pane fade" id="advanced-tab-pane" role="tabpanel" aria-labelledby="advanced-tab" tabindex="0">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Advanced & Output</h5>

                            <h6>Frequency Range</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="min_freq" class="form-label">Min Frequency (Hz) <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Lowest audio frequency the visualizer responds to."></i></label>
                                    <input type="number" class="form-control" id="min_freq" name="min_freq" value="30" min="20" max="500">
                                </div>
                                <div class="col-md-6">
                                    <label for="max_freq" class="form-label">Max Frequency (Hz) <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Highest audio frequency the visualizer responds to."></i></label>
                                    <input type="number" class="form-control" id="max_freq" name="max_freq" value="16000" min="5000" max="22050">
                                </div>
                            </div>

                            <h6 class="mt-4">Video Output Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="duration" class="form-label">Duration (sec) <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Maximum output video duration in seconds. Set to 0 or leave empty to process the full audio track."></i></label>
                                    <input type="number" class="form-control" id="duration" name="duration" value="0" min="0" step="1">
                                </div>
                                <div class="col-md-4">
                                    <label for="fps" class="form-label">FPS <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Frames per second for the output video (e.g., 30, 60). Higher FPS means smoother animation but larger file size and longer processing."></i></label>
                                    <input type="number" class="form-control" id="fps" name="fps" value="30" min="15" max="60">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="width" class="form-label">Video Width (px) <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Width of the output video (e.g., 1280, 1920, 3840)."></i></label>
                                    <input type="number" class="form-control" id="width" name="width" value="1280" min="640" max="3840" step="10">
                                </div>
                                <div class="col-md-6">
                                    <label for="height" class="form-label">Video Height (px) <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Height of the output video (e.g., 720, 1080, 2160)."></i></label>
                                    <input type="number" class="form-control" id="height" name="height" value="720" min="360" max="2160" step="10">
                                </div>
                            </div>
                        </div> <!-- End Card Body -->
                    </div> <!-- End Card -->
                </div> <!-- End Advanced Tab Pane -->
            </div>

            <!-- Submit Button -->
            <div class="d-grid mt-5">
                <button type="submit" class="btn btn-primary btn-lg py-3" id="submit-btn">
                    <i class="bi bi-magic me-2"></i> Generate Visualization
                </button>
                <p class="text-center mt-2" style="color: var(--text-secondary); font-size: 0.9rem;">
                    <i class="bi bi-info-circle me-1"></i> Processing may take a few minutes depending on file size and settings
                </p>
            </div>
        </form>

        <!-- Processing Card -->
        <div id="processing-card" class="card my-5" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu me-2"></i> Processing</h5>
            </div>
            <div class="card-body text-center py-4">
                <div id="processing-animation" class="mb-4">
                    <i class="bi bi-waveform pulse" style="font-size: 3rem; color: var(--primary-color);"></i>
                </div>
                <div class="progress mb-4" style="height: 30px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated fs-6" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="status-message" class="mb-4">Processing your audio file...</p>

                <div id="video-player-container" style="display: none;" class="mb-4">
                    <video id="result-video" class="w-100 rounded shadow" controls>
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div id="download-section" style="display: none;">
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <a id="download-link" href="#" class="btn btn-success btn-lg px-4">
                            <i class="bi bi-download me-2"></i> Download Visualization
                        </a>
                        <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="create-another-btn">
                            <i class="bi bi-plus-circle me-2"></i> Create Another
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Shared Modules -->
    <script src="{{ url_for('static', filename='js/ui-effects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form-utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tab-navigation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tooltip-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/processing-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/shader-selector.js') }}"></script>

    <!-- Background Media Handler JS -->
    <script src="{{ url_for('static', filename='js/background-media-handler.js') }}"></script>

    <!-- Circular Spectrum Form JS -->
    <script src="{{ url_for('static', filename='js/circular_spectrum_form.js') }}"></script>

    <!-- Include the shared error modal -->
    {% include 'partials/error_modal.html' %}
</body>
</html>
